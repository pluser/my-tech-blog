---
title: "光回線の検討"
date: 2018-03-16T13:56:29+09:00
type: posts
draft: true
---

この文書は自宅のインターネット接続環境の契約を考えなおしたメモ書きである。

いま、光回線契約の検討をしている。
まず現状を書いておこう。

# 現在のインターネット接続環境

- NTT東日本サービスエリア
- YahooBB ADSL 50M (バリュープラン、電話加入権が必要なタイプ)
- 料金は月額2,564円
- 他にNTTへ支払う回線使用料が別途
- ADSLは実測で下り20Mbps、上り1Mbps
- 自宅からNTTビルまでの経路長は320m、伝送損失は6dB
- 現在、google.comまでのRTTは25msec程度

NTTまでの距離が平均的な回線に比べて圧倒的に短く、ADSLにも関わらず高速な接続を維持できている。
これぐらいの速度で何ができるかといえば、1080pのYouTube動画を1本途切れなくストリーミング再生できるぐらい。2本同時は厳しい。
下りはなんとかなっても、厳しいのは上りだ。1Mbps前後の速度しか出ないので、ファイルのアップロードなどは果てしなく待たされる。
この上り回線の細さは自宅サーバーを置いている場合に致命的である。他人にアクセスさせる場合はもちろん、自分で使う分にも問題である。

そこで光回線(FTTH)の契約を検討しはじめた。

# 目標スペック

目標は優先順位順に以下が達成されることとした。

1. 現状以上の上り速度
1. IPv6、IPv4グローバルアドレスの供給
1. 少なくとも現状と同等の遅延
1. 少なくとも現状と同等の上り速度
1. 少なくとも現状と同等の可用性

# 使用可能な光回線

現在日本で提供されている光回線契約は大きく3種類に分けられる。

## NTTのフレッツ光
1つめはNTTのフレッツ光である。
日本の一般過程向けに光回線が初めて提供された当時から有る形態。現在の日本ではこのタイプの回線契約数が最も多く、NTT東日本ではおよそ五百万件となっている。
回線契約をNTTと交わし、インターネットと接続するためのプロバイダーは別途結ぶようになっている。そのため、プロバイダーの変更が容易に行なえる。
技術的視点では、利用者はまずNTTが構築したローカルネットワークであるNGNに接続され、そこからプロバイダー毎に容易された相互接続点(POI)へとPPPで接続している。
インターネットへの接続はPPPトンネルを常に通過する形態となっているため、速度が低減してしまう、パケットサイズが制限される、といった問題がある。
特にPOIでの速度低減は顕著で、各プロバイダー毎にセッション数を基準にしてPOIの容量が決められて設置されているため、混雑する条件が揃うと速度が非常に低下する。
さらにPOIの容量はプロバイダーの意向で増減することが難しいため、状況が改善せずに長期間にわたって続いている。

## 光コラボレーション
2つめは光コラボレーションである。
光コラボレーションは比較的最近開始された形態で、基本的にはプロバイダーを回線事業者とセットで提供するという、いわば「セットサービス」だ。現時点での契約数は四百万件。
NTTのフレッツ回線からは「転用」と呼ばれる手続を取ることで、宅内工事なしでこの契約へと変えることができる。しかし、一度「転用」した回線を再度フレッツ回線へと戻したり、別のプロバイダーへと変更することはできない。一度解約して再度契約という手続をとる必要があり、工事費用が必要であったり、電話番号が変更されてしまう、といった問題がある。
電話番号が変わってしまうことについては、一度アナログ回線に戻してから再度契約するなどの手続を取ることで番号の維持も可能だが、その場合さらに工事費用がかさむことになる。
一般的にはNTTとプロバイダーがセットされ、使用料の請求はプロバイダーが一括して行うようになっているが、「ドコモ光」のみは例外で、光コラボレーションでありながらプロバイダーを選ぶことができる。ドコモ光は携帯電話のドコモショップで契約することができ、いってみればドコモショップで契約可能なフレッツ光という状態になっている。

## 独自回線
3つめは独自回線である。
NTTが使っていない光回線である、「ダークファイバー」をプロバイダーが借り受け、NTTビル内に自社設備を設置して接続、利用者宅までその回線を接続するという形態である。NTTは光回線と自社ビル内のスペースを貸すのみである。
この方式はNTTビル内に個別に機器を設置する必要があるため、プロバイダー側にかなりの設備投資が必要である。そのため、現在この方式で回線を提供しているサービスは少なく、KDDI系の「auひかり」、ソニー系の「NURO光」など限られている。また、提供エリアも狭く、都市部に限られている。
プロバイダーから見て、NTTビル内、契約者宅に自社設備を設置しているため、フレッツ光に比べて最新の技術を使うことができ、高速な回線を提供できる可能性がある。

# 通信速度に関する技術的制約
NTTのフレッツ光では、NTTビルから出た光ファイバーは契約者宅に届くまでに最大32分岐されている。一つの光ファイバーに複数の信号を入力するために、GE-PON(Gigabit Ethernet-Passive Optical Network)という技術を使用している。この方式は、おおもとで上下とも1Gbpsが最大通信速度となっている。それを32分岐するのだから、各端末で最大速度で通信した場合、それぞれの速度は31Mbps程度となってしまう。実際に32分岐されることは少ないものの、フレッツ回線の利用者は多く、分岐の数はそれなりに多い。近隣住民の通信に影響を受けて速度が遅くなるのである。

Nuro光でも採用されているG-PON(Gigabit Passive Optical Network)では同様かそれ以上にNTTからの光回線が分割される可能性があるものの、プロバイダー側が光ファイバー単位で借りている関係上、フレッツの利用者などとは異なる光ファイバーを使用することになる[^nurohikarizissoku]。そのため、利用者の絶対数が少ない、こうした回線では光ファイバーが分岐されることが少なく、速度低下を起す可能性が少ない。auひかりではGE-PONを採用しているものの、同様の議論が成り立つ。
G-PONの最大通信速度は上下共10Gbpsとなっており、このサービスを提供しているのは現在のところNURO光のみである[^nuro10g]。

[^nurohikarizissoku]: <https://nuro光実測と評判.jp/gpon/>
[^nuro10g]: <https://www.nuro.jp/10g/> <https://www.sonynetwork.co.jp/corporation/release/2018/pr20180301_0007.html>

# IPv6対応と速度向上
NTTのフレッツや光コラボレーションを契約した場合、POIで速度が低減してしまうことを述べた。
しかし、PPPを使わず、POIを避けることで速度向上を目指すテクニックが存在する。

NGNは各プロバイダーへの接続点であるPOIとは別に、IPv6のインターネットへの接続点をいくつか持っている。数年前まで技術的理由からその数は3つのみに限られていたが、近年になってその数が増えた。
IPv6を利用したいユーザーは、自分の契約プロバイダーに申し込む。プロバイダーは申請を受け、提携しているIPv6接続事業者に指示をする。IPv6接続業者はNGNに置かれたサーバーから、該当ユーザーのパケットをIPv6ネットワークに転送できるように設定する。このようにして、ユーザーはNGNを経由してインターネットに対してIPv6パケットを送出できるようになる。
このままではインターネット上で大半を占めるIPv4のみに対応したサイトやサービスへの接続はPPP経由の低速度なものになってしまう。そこでIPv6接続事業者は、それぞれ独自にIPv4へのトランスレート、もしくはトンネルサービスを提供している。こうしたIPv6への接続やIPv4へのトンネルサービスの価格はプロバイダによって異なる。

このようにしてPOIを避けて直接イーサネットフレームをNGNを経由してやりとりすることで、通信速度低下を回避できる。
こうした工夫によって、下り数Mbpsから100Mbps程度までは高速化できるようだ。
しかし、こうしたIPv4のトンネリングやトランスレートには制約がある。いくつかの方法ではグローバルIPアドレスがもらえない(つまり、NAT越しの接続になる)し、(NAT越しなので)ポートフォワードができないといった問題が発生する。

以下にいくつかの接続業者についてとりあげ、検討する。

## [BBIX] (https://www.bbix.net)
ソフトバンク系の会社。この業者を使用しているのもソフトバンク系のみ。ソフトバンク光はこの業者と提携している。
「IPv6高速ハイブリッド接続」がIPv6インターネット接続とトランスレートサービスの提供に相当するサービス。
他の接続業者とは異なり、トンネルではなくIPv4へのトランスレートを行うことでIPv4への接続性を提供している。
そのため専用機器が必要であるなどの問題があるが、1つのIPv4アドレスを一契約で使用するため、ポートフォワードなどが自由に行える。
グローバルIPアドレスがもらえ、ポートフォワードが自由に可能な唯一の業者である。
トランスレートは4rd/SAMを採用している。

## [JPNE] (https://www.jpne.co.jp/)
日本ネットワークイネイブラー株式会社。
サービス名は「v6プラス」。
MAP-Eという変換方式を採用。1つのグローバルIPアドレスを複数人数で共用している。そのためあらかじめ決まったポート範囲へのフォワードしかできない。ウェルノウンポートのフォワードなどはできない模様。
他にビッグローブやフリービットなども同様の技術を採用している。

## [mfeed] (http://www.mfeed.co.jp/)
インターネットマルチフィード株式会社。
NTTと共同で技術開発を行なっている。NTT系をはじめ、さまざまなプロバイダーが使用している。
サービス名は「IPv4インターネット接続オプションサービス」。
DS-Liteという変換方式を採用。簡単に言えば、業者側でNAT変換される方式。そのため、グローバルIPアドレスがそもそも配られない。ポートフォワードは一切できない。
かわりに、ユーザー側機器(CPE)で特別な操作が必要無いので、ユーザー側に特別な機器が必要無い。

# 候補となるインターネット接続プロバイダー
## [NURO光] (https://www.nuro.jp)
2Gbpsの契約で回線速度は500Mbps以上出る模様[^thesaibase]。対象となるエリアが狭いものの、2Gbpsサービスは契約可能。10Gbpsは現在不可。
IP電話とNTTのひかりTVにも対応する。
10Gbpsは2年間の継続契約が付いて6480円で下り10Gbps、上り2.5Gbpsである。
工事費は40000円、契約解除違約金は9500円、回線撤去工事費は10000円。継続契約とひきかえに、工事費分を割引がされる。
2Gbpsは2年間の継続契約が付いて月額4743円、継続契約無しならば月額7124円。その他は上と同様である。
また、電話サービスである、NURO光電話は月額500円で、ソフトバンクの携帯電話回線とセットで500円から2000円の割引が適用される。
[^thesaibase]: <https://thesaibase.com/net/nuro-speed>

## [ソフトバンク光] (https://www.softbank.jp/ybb/sbhikari/)
フレッツ光、光コラボレーション共に最終的な料金は変わらない模様。
光BBユニットのレンタルが事実上必須[^kaoruya]。これが無い場合、IPv6やトランスレートサービスが使用できないため、POI経由での接続となってしまい、著しい速度低下を感じることになる。
2年間の継続契約が付いて月額5200円、継続契約無しの場合、月額6300円。
工事費は24000円、契約解除違約金は9500円。IPv6のための料金は無料、ただし光BBユニットのレンタルに467円が必要。
[^kaoruya]: <https://kaoruya.org/blog/softbank-collaboration-kaizen/> <http://www.odorikoblog.net/entry/hybrid>

# 参考文献
- [IPv6 IPoE に思いを馳せながら ISP をどうやって選定するか考える話 - Qiita] (https://qiita.com/soprano1125/items/65295cd8c371abc6ebe8)
- [NTTフレッツ光で通信速度及び応答速度を期待できるオススメISP（プロバイダー） - isp_select@ウィキ] (https://www65.atwiki.jp/isp_select/pages/13.html)
- [IIJmioひかりの混雑の理由とバイパス手段(IPoE・DS-Lite対応) - てくろぐ] (http://techlog.iij.ad.jp/archives/1879)
- [DS-LiteでIPv4してみませんか？ - てくろぐ] (http://techlog.iij.ad.jp/archives/1254)
- [フレッツ回線が遅すぎる問題を IPv6/IPoE と DS-Lite で解決した - CUBE SUGAR CONTAINER] (http://blog.amedama.jp/entry/2017/04/08/181728)